<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OpenChat :: Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --bg:#0a0018; --scanline: rgba(255,255,255,0.03); }
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(50% 50% at 20% 20%, rgba(176,92,255,0.12), transparent 60%),
        radial-gradient(40% 40% at 80% 80%, rgba(0,229,229,0.08), transparent 60%),
        var(--bg);
      color:#e8dfff;
      font-family: 'Share Tech Mono', ui-monospace, SFMono-Regular, Menlo, monospace;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .scanlines:before{ content:""; position:fixed; inset:0; pointer-events:none; background-image:linear-gradient(var(--scanline) 1px, transparent 1px); background-size:100% 3px; mix-blend-mode:overlay; opacity:.6 }
    .sidebar{ background: rgba(255,255,255,0.04); border-right: 1px solid rgba(255,255,255,0.12) }
    .panel{ background: rgba(255,255,255,0.04); border-left: 1px solid rgba(255,255,255,0.12) }
    .card{ background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.16) }
    .pill{ background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.14) }
    .bubble{ background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.14) }
    .cutscene{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:50; background:
      radial-gradient(50% 50% at 20% 20%, rgba(176,92,255,0.12), transparent 60%),
      radial-gradient(40% 40% at 80% 80%, rgba(0,229,229,0.08), transparent 60%), var(--bg);
    }
    .cutscene.fade-out{ animation: fadeOut .6s ease forwards }
    @keyframes fadeOut{ to { opacity:0; visibility:hidden } }
    .popup{ position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:40; background:rgba(10,0,24,0.95); border:1px solid rgba(255,255,255,0.2); backdrop-filter:blur(8px) }
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:30; display:none }
    .appear span{opacity:0;display:inline-block;transform:translateY(6px)}
    @keyframes fadeUp{to{opacity:1;transform:translateY(0)}}
  </style>
  <script>
    var chatId;

    document.addEventListener('DOMContentLoaded', function(){
      var path = window.location.pathname || '/chat/0';
      chatId = path.split('/').pop();

      // Character-by-character animation for .appear nodes
      var animatedNodes = document.querySelectorAll('.appear');
      animatedNodes.forEach(function(node, groupIndex){
        var text = (node.textContent || '').trim();
        node.textContent = '';
        for (var i = 0; i < text.length; i++){
          var span = document.createElement('span');
          span.textContent = text[i];
          span.style.animation = 'fadeUp .45s forwards';
          span.style.animationDelay = (i * 45 + groupIndex * 180) + 'ms';
          node.appendChild(span);
        }
      });

      function renderRecent(list){
        var ul = document.getElementById('recentList');
        if(!ul) return;
        ul.innerHTML = '';
        (list||[]).forEach(function(item){
          var li = document.createElement('li');
          li.className = 'flex items-center gap-3 p-2 rounded-md hover:bg-white/5 cursor-pointer';
          li.innerHTML = '<div class="h-8 w-8 rounded-full bg-white/20"></div>'+
                         '<div><div class="text-sm">'+ item.name +'</div>'+
                         '<div class="text-[10px] opacity-70">last: '+ item.last +'</div></div>';
          if (item.id) {
            li.addEventListener('click', function(){ window.location.href = '/chat/' + item.id; });
          }
          ul.appendChild(li);
        });
      }

      function renderChatInfo(info){
        var botsWrap = document.getElementById('botsInfo');
        var metaWrap = document.getElementById('chatMeta');
        var rolesWrap = document.getElementById('rolesWrap');
        if(botsWrap){
          botsWrap.innerHTML = '';
          (info.bots||[]).forEach(function(b){
            var row = document.createElement('div');
            row.className = 'flex items-center gap-3 p-2 rounded-md hover:bg-white/5';
            row.innerHTML = '<div class="h-9 w-9 rounded-full bg-white/25"></div>'+
                            '<div><div class="text-sm">'+ (b.name||'') +'</div>'+
                            '<div class="text-[10px] opacity-70">'+ (b.description||'') +'</div></div>';
            botsWrap.appendChild(row);
          });
        }
        if(metaWrap){
          metaWrap.innerHTML = '';
          var grid = document.createElement('div');
          grid.className = 'grid grid-cols-2 gap-2 text-[12px]';
          grid.innerHTML = '<div class="opacity-70">Created</div><div>'+(info.createdAt||'-')+'</div>'+
                           '<div class="opacity-70">Messages</div><div>'+(info.totalMessages||0)+'</div>';
          metaWrap.appendChild(grid);
        }
        if(rolesWrap){
          rolesWrap.innerHTML = '';
          (info.roles||[]).forEach(function(r){
            var p = document.createElement('div');
            p.className = 'flex items-center gap-2 p-2 rounded-md card';
            p.innerHTML = '<div class="h-6 w-6 rounded bg-white/25"></div>'+
                          '<div class="text-sm">'+ (r.name||'') +'</div>';
            rolesWrap.appendChild(p);
          });
        }
      }

      function renderMessages(items){
        var list = document.getElementById('messages');
        if(!list) return;
        list.innerHTML = '';
        (items||[]).forEach(function(m){
          var row = document.createElement('div');
          row.className = 'flex items-start gap-3';
          row.innerHTML = '<div class="h-9 w-9 rounded-full bg-white/25"></div>'+
                          '<div class="flex-1">'+
                            '<div class="text-[12px] opacity-80 mb-1">'+ (m.sender?.name || 'user') +'</div>'+
                            '<div class="bubble rounded-lg p-3">'+ (m.text || '') +'</div>'+
                          '</div>';
          list.appendChild(row);
        });
      }

      Promise.all([
        fetch('/api/recent').then(function(r){return r.json();}).catch(function(){return[];}),
        fetch('/api/chat/'+chatId+'/info').then(function(r){return r.json();}).catch(function(){return{};}),
        fetch('/api/chat/'+chatId+'/messages').then(function(r){return r.json();}).catch(function(){return[];})
      ]).then(function(res){
        renderRecent(res[0]);
        renderChatInfo(res[1]);
        renderMessages(res[2]);
        
        // Hide cutscene after data loads
        setTimeout(function(){
          var overlay = document.getElementById('cutscene');
          if(overlay) overlay.classList.add('fade-out');
        }, 1200);
        setTimeout(function(){
          var overlay = document.getElementById('cutscene');
          if(overlay) overlay.style.display = 'none';
        }, 1800);
      });

      // Popup toggle
      function toggleInfo(){
        var overlay = document.getElementById('infoOverlay');
        var popup = document.getElementById('infoPopup');
        if(overlay && popup){
          if(overlay.style.display === 'none' || !overlay.style.display){
            overlay.style.display = 'block';
            popup.style.display = 'block';
          } else {
            overlay.style.display = 'none';
            popup.style.display = 'none';
          }
        }
      }
      
      window.toggleInfo = toggleInfo;
    });

    async function sendMessage() {
      const input = document.getElementById("messageInput");
      const text = input.value.trim();

      if (text !== "") {
        const messages = document.getElementById("messages");
        const row = document.createElement("div");
        row.className = "flex items-start gap-3";
        row.innerHTML = `
          <div class="h-9 w-9 rounded-full bg-white/25"></div>
          <div class="flex-1">
            <div class="text-[12px] opacity-80 mb-1">you</div>
            <div class="bubble rounded-lg p-3">${text}</div>
          </div>`;
        messages.appendChild(row);

        // отправляем сообщение на сервер
        try {
          const response = await fetch("http://localhost:8080/api/chat/" + chatId + "/send_message", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ message: text })
          });

          if (!response.ok) {
            console.error("Ошибка при отправке сообщения:", response.statusText);
          } else {
            const data = await response.json();
            console.log("Ответ сервера:", data);
          }
        } catch (err) {
          console.error("Ошибка сети:", err);
        }

        input.value = "";
        messages.scrollTop = messages.scrollHeight; // автоскролл вниз
      }
    }


    // Отправка по Enter
    document.addEventListener("DOMContentLoaded", () => {
      const input = document.getElementById("messageInput");
      if (input) {
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            sendMessage();
          }
        });
      }
    });
  </script>
</head>
<body class="scanlines">
  <!-- Cutscene overlay -->
  <div id="cutscene" class="cutscene">
    <div>
      <h1 class="appear text-center text-4xl tracking-[0.35em]">OPENCHAT</h1>
    </div>
  </div>

  <!-- Popup overlay -->
  <div id="infoOverlay" class="overlay" onclick="toggleInfo()"></div>

  <div class="min-h-screen flex">
    <!-- Left: recent + profile like main -->
    <aside class="sidebar w-64 hidden md:flex flex-col">
      <div class="p-4 border-b border-white/10">
        <a href="/main" class="text-lg tracking-widest hover:opacity-80">OPENCHAT</a>
      </div>
      <div class="p-4">
        <div class="text-xs tracking-widest mb-3 opacity-80">RECENT</div>
        <ul id="recentList" class="space-y-2"></ul>
      </div>
      <div class="mt-auto p-4 border-t border-white/10">
        <button type="button" onclick="window.location.href='/profile'" class="w-full flex items-center gap-3 p-2 rounded-md hover:bg-white/5">
          <div class="h-8 w-8 rounded-full bg-white/25"></div>
          <div>
            <div class="text-sm">@username</div>
            <div class="text-[10px] opacity-70">Profile</div>
          </div>
        </button>
      </div>
    </aside>

    <!-- Center: messages -->
    <main class="flex-1 flex flex-col px-4 md:px-8 py-6 gap-4">
      <div class="flex items-center justify-between mb-1">
        <div class="flex items-center gap-4">
          <h1 class="text-2xl tracking-widest">CHAT</h1>
          <button onclick="toggleInfo()" class="text-sm px-3 py-2 rounded-md border border-white/20 hover:bg-white/5">Info</button>
        </div>
      </div>
      <div class="flex-1 card rounded-lg p-4 overflow-y-auto" style="max-height: calc(100vh - 180px)">
        <div id="messages" class="space-y-4"></div>
      </div>

      <!-- Поле ввода -->
      <div class="flex items-center gap-2">
        <input 
          id="messageInput"
          type="text"
          placeholder="Enter message..."
          class="flex-1 px-4 py-2 rounded-lg border border-white/20 bg-white/5 focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
        <button 
          onclick="sendMessage()" 
          class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white"
        >
          Отправить
        </button>
      </div>
    </main>    
  </div>

  <!-- Chat info popup -->
  <div id="infoPopup" class="popup rounded-lg p-6 w-80 max-h-[80vh] overflow-y-auto" style="display:none">
    <div class="space-y-5">
      <div class="flex items-center justify-between">
        <h2 class="text-lg tracking-widest">CHAT INFO</h2>
        <button onclick="toggleInfo()" class="text-xl">&times;</button>
      </div>
      <div>
        <div class="text-xs tracking-widest mb-2 opacity-80">BOTS</div>
        <div id="botsInfo" class="space-y-2"></div>
      </div>
      <div>
        <div class="text-xs tracking-widest mb-2 opacity-80">CHAT INFO</div>
        <div id="chatMeta" class="card rounded-lg p-3"></div>
      </div>
      <div>
        <div class="text-xs tracking-widest mb-2 opacity-80">ROLES</div>
        <div id="rolesWrap" class="space-y-2"></div>
      </div>
    </div>
  </div>
</body>
</html>


